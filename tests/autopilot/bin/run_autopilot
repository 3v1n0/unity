#!/usr/bin/env python

import os
import sys
import junitxml
from optparse import OptionParser
from unittest.loader import TestLoader
from unittest.runner import TextTestRunner

if __name__ == "__main__":
	parser = OptionParser()
	parser.add_option('-o', '--output', dest='outfile', default='',
			  help='Write test result report to file. Defaults to stdout')
	(options, args) = parser.parse_args()

	if options.outfile == '':
		results_stream = sys.stdout
	else:
		if not os.path.exists(options.outfile):
			os.makedirs(options.outfile)
		results_stream = open(options.outfile, 'w')

	loader = TestLoader()
	result = junitxml.JUnitXmlResult(results_stream)
	result.startTestRun()
	test_suite = loader.discover('autopilot.tests')
	test_suite.run(result)
	result.stopTestRun()
	results_stream.close()

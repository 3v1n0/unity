#!/usr/bin/env python

import os
import sys
import junitxml
from argparse import ArgumentParser
from unittest.loader import TestLoader
from unittest.runner import TextTestRunner


if __name__ == "__main__":
	parser = ArgumentParser()
        parser.add_argument('-o', "--output", required=False,
        	help='Write test result report to file. Defaults to stdout')
        parser.add_argument('-f', "--format", choices=['text', 'xml'], default='text',
        	required=False, help='Specify desired output format. Default is "text".')
	args = parser.parse_args()

	if args.output == None:
		results_stream = sys.stdout
	else:
		try:
			path = os.path.dirname(args.output)
			if path != '' and not os.path.exists(path):
				os.makedirs(path)
			results_stream = open(args.output, 'w')
		except:
			results_stream = sys.stdout

	loader = TestLoader()
	test_suite = loader.discover('autopilot.tests')

	if args.format == "xml":
		result = junitxml.JUnitXmlResult(results_stream)
		result.startTestRun()
		test_suite.run(result)
		result.stopTestRun()
		results_stream.close()
		if not result.wasSuccessful:
			exit(1)
	elif args.format == "text":
		runner = TextTestRunner(stream=results_stream)
		success = runner.run(test_suite).wasSuccessful()
		if not success:
			exit(1)


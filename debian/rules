#!/usr/bin/make -f
# -*- makefile -*-

# Uncomment this to turn on verbose mode.
export DH_VERBOSE=1

DEB_HOST_ARCH ?= $(shell dpkg-architecture -qDEB_HOST_ARCH)
DEB_VERSION := $(shell dpkg-parsechangelog | egrep '^Version:' | cut -f 2 -d ' ')

CFLAGS=$(shell echo $$CFLAGS | sed -e 's/\-Wall//')

CORE_ABIVERSION := $(shell sed -rn 's/^\#define[[:space:]]+CORE_ABIVERSION[[:space:]]+//p' /usr/include/compiz/core/core.h )

override_dh_auto_configure:
	dh_auto_configure -- -DCOMPIZ_BUILD_WITH_RPATH=FALSE -DCOMPIZ_PACKAGING_ENABLED=TRUE -DCOMPIZ_PLUGIN_INSTALL_TYPE=package


override_dh_install:
	find debian/tmp/usr/lib -name \*.*a -exec rm {} \;
	dh_install --fail-missing

override_dh_gencontrol:
	dh_gencontrol -- -Vcoreabiversion=$(CORE_ABIVERSION)
	# override netbook-launcher for i386 to get an epoch
ifeq ($(DEB_HOST_ARCH),i386)
		rm debian/netbook-launcher/DEBIAN/control
		dpkg-gencontrol -pnetbook-launcher -ldebian/changelog -Tdebian/netbook-launcher.substvars -Pdebian/netbook-launcher -Vcoreabiversion=20101111 -v2:$(DEB_VERSION) 
		chmod 644 debian/netbook-launcher/DEBIAN/control
		chown 0:0 debian/netbook-launcher/DEBIAN/control
endif

override_dh_auto_test:
	echo "not working right now"

%:
	dh $@
